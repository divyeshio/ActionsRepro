name: ci-pr

on:
  workflow_dispatch:

env:
  DOTNET_VERSION: "10.0.x"
  SOLUTION_FILE: ActionsRepro.slnx
  TEST_RESULTS_DIR: TestResults/ci

jobs:
  backend:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Set up .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Trust Dev Cert
        run: dotnet dev-certs https --trust
        env:
          WSL_INTEROP: ""
        continue-on-error: true

      - name: Restore
        run: dotnet restore ${{ env.SOLUTION_FILE }}

      - name: Build
        run: dotnet build ${{ env.SOLUTION_FILE }} --configuration Release --no-restore

      - name: List tests
        run: dotnet test --solution ${{ env.SOLUTION_FILE }} --list-tests

      - name: Run tests
        env:
          DCP_DIAGNOSTICS_LOG_LEVEL: debug
          TESTINGPLATFORM_DIAGNOSTIC: 1
          TESTINGPLATFORM_DIAGNOSTIC_VERBOSITY: Debug
        run: >-
          dotnet test --solution ${{ env.SOLUTION_FILE }}
          --configuration Release
          --no-build
          --report-trx
          --results-directory ${{ env.TEST_RESULTS_DIR }}
          --verbosity diag
          --output Detailed
          --hangdump
          --crashdump
